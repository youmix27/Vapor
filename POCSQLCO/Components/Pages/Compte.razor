@page "/compte"
@using Microsoft.AspNetCore.Authorization
@using POCSQLCO.Models
@using Microsoft.AspNetCore.Cryptography.KeyDerivation;
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using System.Security.Cryptography
@inject Models.IVaporService VaporService
@inject NavigationManager NavManager
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Administrator, User")]

<PageTitle>Mon Compte</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium">
    <MudGrid>
        <MudItem xs="12" sm="7">
            <EditForm Model=@oldUtilisateur OnValidSubmit="UpdateUtilisateur">
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-4"> Mon compte </MudText>
                    <MudTextField @bind-Value="oldUtilisateur.Pseudo" For="@(() => oldUtilisateur.Pseudo)" Label="Pseudo" />
                    <MudTextField @bind-Value="oldUtilisateur.Email" For="@(() => oldUtilisateur.Email)" Label="Mail" />
                    <MudTextField @bind-Value="oldUtilisateur.Nom" For="@(() => oldUtilisateur.Nom)" Label="Nom" />
                    <MudTextField @bind-Value="oldUtilisateur.Prenom" For="@(() => oldUtilisateur.Prenom)" Label="Prenom" />
                    <MudTextField @bind-Value="oldUtilisateur.Ville" For="@(() => oldUtilisateur.Ville)" Label="Ville" />
                    <MudTextField @bind-Value="oldUtilisateur.CodePostal" For="@(() => oldUtilisateur.CodePostal)" Label="Code Postal" />
                    <MudTextField @bind-Value="oldUtilisateur.Adresse" For="@(() => oldUtilisateur.Adresse)" Label="Adresse" />
                    <MudTextField @bind-Value="oldUtilisateur.Telephone" For="@(() => oldUtilisateur.Telephone)" Label="Numéro de Téléphone" />
                    <MudCheckBox @bind-Value="oldUtilisateur.FiltreCs" Label="Masquer contenu à caractère sexuel"></MudCheckBox>
                    <MudCheckBox @bind-Value="oldUtilisateur.FiltreGore" Label="Masquer contenu à caractère gore"></MudCheckBox>
                </MudPaper>
                <MudPaper Class="pa-4 mt-4">
                    <MudAlert Class="mb-4" Severity="Severity.Error" hidden="@ErrorPseudo">Nom d'utilisateur déjà utilisé par un autre compte'</MudAlert>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" DisableElevation="true" ButtonType="ButtonType.Submit">Sauvegarder</MudButton>
                </MudPaper>
            </EditForm>
            <EditForm Model=@newPassword OnValidSubmit="Update">
                <MudPaper Class="pa-4 mt-4">
                    <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-4"> Modifier Mot de Passe </MudText>
                    <MudTextField @bind-Value="newPassword.AncienPassword" For="@(() => newPassword.AncienPassword)" InputType="InputType.Password" Label="Ancien Mot de Passe" />
                    <MudTextField @bind-Value="newPassword.NouveauPassword" For="@(() => newPassword.NouveauPassword)" InputType="InputType.Password" Label="Nouveau Mot de Passe" />
                    <MudTextField @bind-Value="newPassword.NouveauPassword2" For="@(() => newPassword.NouveauPassword2)" InputType="InputType.Password" Label="Confirmation Nouveau Mot de Passe" />
                </MudPaper>
                <MudPaper Class="pa-4 mt-4">
                    <MudAlert Class="mb-4" Severity="Severity.Error" hidden="@ErrorPassword">Erreur sur l'ancien mot de passe</MudAlert>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" DisableElevation="true" ButtonType="ButtonType.Submit">Sauvegarder</MudButton>
                </MudPaper>
            </EditForm>
        </MudItem>
    </MudGrid>
</MudContainer>



@code{
    [CascadingParameter]
    private Task<AuthenticationState> authenticationState { get; set; }

    public Utilisateur oldUtilisateur { get; set; } = new Utilisateur();

    public NewPassword newPassword { get; set; } = new NewPassword();

    public bool ErrorPassword { get; set; } = true;

    public bool ErrorPseudo { get; set; } = true;

    public class NewPassword
    {
        [Required(ErrorMessage = "Veuillez préciser l'ancien mot de passe")]
        public string AncienPassword { get; set; }

        [Required(ErrorMessage = "Veuillez préciser le nouveau mot de passe")]
        [StringLength(30, ErrorMessage = "Le mot de passe doit faire 8 char minimum.", MinimumLength = 8)]
        public string NouveauPassword { get; set; }

        [Required(ErrorMessage = "Veuillez préciser la confirmation du nouveau mot de passe")]
        [Compare(nameof(NouveauPassword), ErrorMessage = "les deux mots de passes sont différents")]
        public string NouveauPassword2 { get; set; }
    }


    protected override async void OnInitialized()
    {
        var authState = await authenticationState;
        oldUtilisateur = VaporService.FindUtilisateurByPseudo(authState.User.Identity.Name);

    }

    private async Task UpdateUtilisateur(EditContext context)
    {
        Utilisateur utilisateurVerificationPseudoDouble = VaporService.FindUtilisateurByPseudo(oldUtilisateur.Pseudo);
        var authState = await authenticationState;
        if (oldUtilisateur.Pseudo != authState.User.Identity.Name && utilisateurVerificationPseudoDouble != null) // si le pseudo a été changé, on vérifit que celui ci ne soit pas utilisé par un autre compte
        {
            ErrorPseudo = false;
            return;
        }
        VaporService.UpdateUtilisateur(oldUtilisateur);
    }

    private void Update()
    {
        if (BCrypt.Net.BCrypt.Verify(newPassword.AncienPassword, oldUtilisateur.HashMdp))
        {
            oldUtilisateur.HashMdp = BCrypt.Net.BCrypt.HashPassword(newPassword.NouveauPassword);
            VaporService.UpdateUtilisateur(oldUtilisateur);
            ErrorPassword = true;
        }
        else
        {
            ErrorPassword = false;
        }

    }

    
}